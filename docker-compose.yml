services:
  motion_trim:
    container_name: "MotionCut"
    build:
      context: .
      dockerfile: Dockerfile
    image: "me:v1"
    env_file:
      - config/motion_trim.env
    environment:
      - INPUT_FILE=${INPUT_FILE:-}

    # CPU PINNING CONFIGURATION
    cpuset: "0,2,4,6,8,10,12,14"
    # cpuset: "0,2"

    deploy:
      resources:
        limits:
          cpus: "8"
          memory: 10G
        reservations:
          cpus: "8"
          memory: 10G

    networks:
      - motion_trim_net

    volumes:
      - ./tmp:/input:ro # Input DVRs (read-only)
      - ./output:/output:rw # Output processed DVRs
      - ./config:/etc/mc/configs:ro # Config files

    # Development mode: sleep infinity to allow exec into container
    # Run manually: /usr/local/bin/motion_trim /input/$INPUT_FILE /output/$INPUT_FILE
    # command: ["sleep", "infinity"]

    # Override CMD to process input file (set INPUT_FILE env var)
    # Example: INPUT_FILE=video.mp4 docker compose up
    command: >
      /bin/bash -c "
        if [ -n \"$$INPUT_FILE\" ]; then
          /usr/local/bin/motion_trim /input/$$INPUT_FILE /output/$$INPUT_FILE;
        else
          /usr/local/bin/motion_trim /input /output;
        fi
      "

networks:
  motion_trim_net:
    driver: bridge
